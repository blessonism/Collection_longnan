# 周小结管理平台

周小结收集、AI 校对、批量归档一体化平台。

## 功能

- 在线填写周小结（格式由模板控制）
- 自动格式化（一行多条自动拆分为每条一行）
- AI 内容校对（规则检查 + AI 语义检查）
- 一键修复校对问题
- 导出标准格式 Word 文档
- 批量归档打包下载
- 管理员配置面板（自定义规则和 Prompt）

## 技术栈

| 层级 | 技术 |
|------|------|
| 前端 | React + TypeScript + Tailwind CSS + shadcn/ui |
| 后端 | Python + FastAPI + SQLAlchemy (async) |
| 数据库 | SQLite (aiosqlite) |
| AI | DeepSeek API (OpenAI 兼容接口) |
| 文档处理 | python-docx |

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端 (React + Vite)                       │
├─────────────┬─────────────┬─────────────┬───────────────────┤
│ SummaryForm │ SubmissionList │ ArchivePanel │ AdminPanel    │
│ (填写表单)   │ (提交记录)     │ (批量归档)   │ (管理配置)    │
└──────┬──────┴──────┬───────┴──────┬──────┴────────┬─────────┘
       │             │              │               │
       ▼             ▼              ▼               ▼
┌─────────────────────────────────────────────────────────────┐
│                    后端 (FastAPI)                            │
├─────────────────────────────────────────────────────────────┤
│  Routers:                                                   │
│  ├── form.py      → 表单提交、草稿、Word导出                 │
│  ├── check.py     → 校对接口 (普通/SSE流式)                  │
│  ├── submission.py → CRUD 操作                              │
│  ├── archive.py   → 批量打包下载                            │
│  └── admin.py     → 管理员配置 (HTTP Basic Auth)            │
├─────────────────────────────────────────────────────────────┤
│  Services:                                                  │
│  ├── checker/                                               │
│  │   ├── rule_checker.py         → 规则检查器 (确定性)       │
│  │   ├── deepseek_checker.py     → AI 错字检查器            │
│  │   ├── punctuation_ai_checker.py → AI 标点检查器          │
│  │   └── config_loader.py        → 配置加载器               │
│  ├── exporter.py                 → Word 导出                │
│  └── archiver.py                 → ZIP 打包                 │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层                                    │
│  ├── SQLite (submissions, system_configs)                   │
│  ├── uploads/   (上传文件)                                  │
│  └── archives/  (归档文件)                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 自动格式化

点击"AI 校对"按钮时，系统会自动将一行多条内容拆分为每条一行：

```
输入：1.持续跟进工作。2.对接协会。3.继续招商。

格式化后：
1.持续跟进工作。
2.对接协会。
3.继续招商。
```

支持 `1.` `2.` 和 `1、` `2、` 两种序号格式。

---

## 校对处理 Pipeline

校对采用**规则检查 + AI 双检查**三层架构，分段并行处理。

```
用户内容
    │
    ▼
自动格式化（一行多条 → 每条一行）
    │
    ├──────────────────────────────────────┐
    ▼                                      ▼
本周工作部分                           下周计划部分
    │                                      │
    ├─────────┬─────────┐                  ├─────────┬─────────┐
    ▼         ▼         ▼                  ▼         ▼         ▼
规则检查   AI错字    AI标点             规则检查   AI错字    AI标点
    │         │         │                  │         │         │
    └─────────┴─────────┴──────────────────┴─────────┴─────────┘
                              │
                              ▼
                         去重合并
```

### 第一层：规则检查器（快速、确定性）

处理明确的格式和标点规则，不需要 AI，用代码逻辑直接检测。

| 检测项 | 规则 | 示例 |
|--------|------|------|
| 序号格式 | 必须是 `1.` 格式 | `1、` → `1.`，`1。` → `1.`，`1. ` → `1.` |
| 英文逗号 | 转中文逗号 | `,` → `，` |
| 英文分号 | 转中文分号 | `;` → `；` |
| 英文冒号 | 转中文冒号（排除时间格式） | `:` → `：` |
| 英文问号 | 转中文问号 | `?` → `？` |
| 英文感叹号 | 转中文感叹号 | `!` → `！` |
| 英文括号 | 括号内有中文时转中文括号 | `(内容)` → `（内容）` |
| 斜杠 | 中文语境中转分号 | `工作/会议` → `工作；会议` |
| 连续标点 | 去除重复 | `。。` → `。` |
| 句末标点 | 每条必须以句号结尾 | `；` → `。`，`！` → `。`，无句号则提醒添加 |
| 多余空格 | 中文间不应有空格 | `工作 内容` → `工作内容` |

### 第二层：AI 错字检查器（deepseek_checker）

专门检查错别字，调用 DeepSeek API。

| 检测项 | 说明 | 示例 |
|--------|------|------|
| 错别字 | 明确的错字 | `按排` → `安排`，`工做` → `工作` |

### 第三层：AI 标点检查器（punctuation_ai_checker）

专门检查需要语义理解的标点问题，调用 DeepSeek API。

| 检测项 | 说明 | 示例 |
|--------|------|------|
| 句中误用句号 | 句号只能在句末 | `资料。报告` → `资料报告` |
| 句号后跟逗号 | 错误组合 | `。，` → `，` 或 `；` |
| 独立任务间用分号 | 主语切换或动作独立时 | `推进换届，已完成选举` → `推进换届；已完成选举` |

**分号判断规则：**
- 主语切换时用分号
- 动作完全独立时用分号
- "已完成/已组织/已..."开头的新分句用分号

**AI 检查原则：**
- 宁可漏报，不可误报
- 不检查专有名词（地名、人名、机构名）
- 不做"优化建议"或"补充完善"

### 公文标点规范要点

1. **分号 `；`** 用于分隔同一条内的并列事项
2. **句号 `。`** 用于每条工作的结尾
3. **冒号 `：`** 用于总述后引出具体内容，不要改成分号

---

## Word 导出格式

严格匹配模板 `周小结模板/凌声明周小结-11.29-12.5.docx`：

| 元素 | 字体 | 字号 | 其他 |
|------|------|------|------|
| 标题 | 方正小标宋简体 | 22磅 | 居中 |
| 姓名 | 仿宋_GB2312 | 16磅（三号） | 居中 |
| 区块标题 | 黑体 | 16磅（三号） | 首行缩进2字符 |
| 正文 | 仿宋_GB2312 | 16磅（三号） | 首行缩进2字符 |
| 空行 | - | 16磅（三号） | 姓名后、下周计划前 |

**页面设置：**
- 行距：固定值 28 磅
- 页边距：上 3.7cm，下 3.5cm，左右 2.8cm

---

## 数据模型

**Submission（提交记录）**
```
id, name, date_range, weekly_work, next_week_plan
source (form/upload), status (draft/submitted/checked/archived)
check_result (JSON), created_at, updated_at
```

**SystemConfig（系统配置）**
```
key, value (JSON), description, updated_at
```

---

## 快速开始

### 1. 配置环境变量

```bash
cd backend
cp .env.example .env
# 编辑 .env，填入 DeepSeek API Key
```

### 2. 启动后端

```bash
cd backend
pip install -r requirements.txt
uvicorn app.main:app --reload
```

### 3. 启动前端

```bash
cd frontend
npm install
npm run dev
```

### 4. 访问

打开 http://localhost:5173

## API 文档

启动后端后访问 http://localhost:8000/docs

---

## 管理员配置

点击页面右上角的设置图标进入管理员面板。

**默认账号：**
- 用户名：`admin`
- 密码：`admin123`

可在 `.env` 文件中修改：
```
ADMIN_USERNAME=your_username
ADMIN_PASSWORD=your_password
```

**可配置项：**

| 配置项 | 说明 |
|--------|------|
| 规则检查开关 | 启用/禁用各项规则检查（序号格式、标点、空格等） |
| AI 检查开关 | 启用/禁用错别字检查、标点语义检查 |
| System Prompt | 自定义 AI 的行为和检查规则 |

---

## 项目结构

```
weekly-summary-platform/
├── backend/
│   ├── app/
│   │   ├── main.py              # FastAPI 入口
│   │   ├── config.py            # 配置
│   │   ├── database.py          # 数据库连接
│   │   ├── schemas.py           # Pydantic 模型
│   │   ├── models/
│   │   │   ├── submission.py    # 提交记录模型
│   │   │   └── config.py        # 系统配置模型
│   │   ├── routers/
│   │   │   ├── form.py          # 表单接口
│   │   │   ├── check.py         # 校对接口
│   │   │   ├── submission.py    # 提交记录接口
│   │   │   ├── archive.py       # 归档接口
│   │   │   └── admin.py         # 管理员接口
│   │   └── services/
│   │       ├── checker/
│   │       │   ├── rule_checker.py           # 规则检查器
│   │       │   ├── deepseek_checker.py       # AI错字检查器
│   │       │   ├── punctuation_ai_checker.py # AI标点检查器
│   │       │   └── config_loader.py          # 配置加载器
│   │       ├── exporter.py      # Word导出
│   │       └── archiver.py      # 批量归档
│   ├── data/                    # SQLite 数据库
│   ├── uploads/                 # 上传文件
│   ├── archives/                # 归档文件
│   └── requirements.txt
│
├── frontend/
│   ├── src/
│   │   ├── App.tsx              # 主应用
│   │   ├── main.tsx             # 入口
│   │   ├── components/
│   │   │   ├── SummaryForm.tsx      # 填写表单组件
│   │   │   ├── SubmissionList.tsx   # 提交记录列表
│   │   │   ├── SubmissionDetail.tsx # 提交详情
│   │   │   ├── ArchivePanel.tsx     # 归档面板
│   │   │   ├── AdminPanel.tsx       # 管理员面板
│   │   │   └── ui/                  # shadcn 组件
│   │   └── lib/
│   │       └── api.ts           # API 封装
│   ├── package.json
│   └── vite.config.ts
│
└── README.md
```
