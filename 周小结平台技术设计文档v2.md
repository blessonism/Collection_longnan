# 周小结管理平台 - 技术设计文档 v2

## 一、核心设计理念

**从源头消除问题，而非事后修补**

| 收集方式 | 格式问题 | 内容问题 | 处理策略 |
|----------|----------|----------|----------|
| 平台内填写 | 模板控制，无需校对 | DeepSeek 校对 | 导出标准格式文档 |
| 平台外上传 | 格式校对 + 自动修正 | DeepSeek 校对 | 标记问题 + 建议修改 |

**AI 内容校对为通用模块，两种收集方式共用。**

---

## 二、系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (React + shadcn)                     │
├───────────────┬───────────────┬─────────────────┬───────────────┤
│   在线填写    │   文件上传    │    校对审核     │   归档下载    │
│   (表单模板)  │   (Word文件)  │    (问题列表)   │   (批量打包)  │
└───────┬───────┴───────┬───────┴────────┬────────┴───────┬───────┘
        │               │                │                │
        ▼               ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       后端 (FastAPI)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐                              │
│  │  表单服务   │  │  上传服务   │                              │
│  │  - 保存数据 │  │  - 存储文件 │                              │
│  │  - 导出Word │  │  - 解析内容 │                              │
│  └──────┬──────┘  └──────┬──────┘                              │
│         │                │                                      │
│         └───────┬────────┘                                      │
│                 ▼                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              校对引擎（通用模块）                         │   │
│  │  ┌───────────────────┐  ┌───────────────────────────┐   │   │
│  │  │ 格式校对          │  │ AI 内容校对 (DeepSeek)    │   │   │
│  │  │ (仅上传文件需要)  │  │ (表单/上传 均调用)        │   │   │
│  │  │ - 字体/字号/行距  │  │ - 错字检测               │   │   │
│  │  └───────────────────┘  │ - 标点校对               │   │   │
│  │                         │ - 语句通顺度             │   │   │
│  │                         └───────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                 │                                                │
│                 ▼                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    归档服务                              │   │
│  │  批量重命名 → 排序 → 打包ZIP → 生成清单                 │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、功能模块详细设计

### 3.1 模块A：平台内在线填写（推荐方式）

#### 设计思路
- 领导在网页表单中填写内容
- 格式由前端模板 + 后端导出模板统一控制
- 填写完成后自动触发 DeepSeek 内容校对
- 导出时生成标准格式 Word 文档

#### 表单字段设计（基于实际模板）

**模板结构分析：**
```
周小结（11.29-12.5）     ← 标题：周小结 + 日期范围
凌声明                   ← 姓名

本周工作：               ← 区块标题
1.xxx                    ← 编号列表，每条一个工作项
2.xxx
...

下周计划：               ← 区块标题
1.xxx
2.xxx
...
```

```typescript
interface WeeklySummaryForm {
  name: string;              // 姓名
  dateRange: string;         // 日期范围，如 "11.29-12.5"
  weeklyWork: string;        // 本周工作（多行文本，支持编号列表）
  nextWeekPlan: string;      // 下周计划（多行文本，支持编号列表）
}
```

#### 前端页面
- 富文本编辑器（可选）或纯文本输入
- 实时字数统计
- 暂存草稿功能
- 提交前预览

#### 后端接口
```
POST /api/form/submit
  - 参数：WeeklySummaryForm
  - 流程：保存 → 调用通用AI校对模块 → 返回校对结果
  - 返回：submission_id, check_result

POST /api/form/draft
  - 保存草稿

GET /api/form/export/{submission_id}
  - 导出为标准格式 Word 文档

POST /api/check/content
  - 通用 AI 内容校对接口
  - 参数：{ text: string } 或 { submission_id: int }
  - 返回：校对结果（错字、标点、语法问题列表）
```

#### Word 导出模板
```python
# 后端使用 python-docx 按模板生成
def export_to_word(data: WeeklySummaryForm) -> bytes:
    doc = Document()
    
    # 标题
    title = doc.add_heading(f'{data.name} 周小结', level=1)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    # 基本信息
    doc.add_paragraph(f'部门：{data.department}')
    doc.add_paragraph(f'周次：{data.week_number}')
    
    # 内容区块（统一格式）
    doc.add_heading('一、本周完成工作', level=2)
    doc.add_paragraph(data.work_completed)
    
    # ... 其他区块
    
    # 统一设置字体、字号、行距
    for para in doc.paragraphs:
        for run in para.runs:
            run.font.name = '仿宋'
            run.font.size = Pt(14)
    
    return doc
```

---

### 3.2 模块B：平台外文件上传

#### 适用场景
- 领导习惯用 Word 编辑
- 过渡期兼容旧流程

#### 校对流程
```
上传 Word → 解析内容 → 格式校对 → DeepSeek内容校对 → 生成报告
                ↓
         ┌─────┴─────┐
         ▼           ▼
    格式问题      内容问题
    (字体/字号)   (错字/标点)
         │           │
         ▼           ▼
    标记位置      AI修改建议
```

#### 格式校对规则
```python
class FormatChecker:
    # 可配置的格式规范
    RULES = {
        'title_font': '黑体',
        'title_size': 16,
        'body_font': ['仿宋', '宋体'],
        'body_size': [12, 14],  # 小四或四号
        'line_spacing': 1.5,
    }
    
    def check(self, doc_path: str) -> list[FormatIssue]:
        # 检查并返回问题列表
        pass
```

#### DeepSeek 内容校对
```python
class DeepSeekChecker:
    SYSTEM_PROMPT = """你是一个公文校对助手，请检查以下文本中的：
1. 错别字
2. 标点符号错误（特别是中英文标点混用）
3. 语句不通顺的地方
4. 用词不当

请以 JSON 格式返回问题列表，每个问题包含：
- location: 问题位置描述
- original: 原文
- suggestion: 修改建议
- type: 问题类型 (typo/punctuation/grammar/wording)
"""

    async def check(self, content: str) -> list[ContentIssue]:
        response = await self.client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": self.SYSTEM_PROMPT},
                {"role": "user", "content": content}
            ],
            response_format={"type": "json_object"}
        )
        return parse_issues(response)
```

#### 后端接口
```
POST /api/upload
  - 上传 Word 文件
  - 返回：upload_id

POST /api/check/{upload_id}
  - 触发校对（格式 + DeepSeek）
  - 返回：check_result

POST /api/check/{upload_id}/apply
  - 应用 AI 建议的修改
  - 返回：修改后的文档
```

---

### 3.3 模块C：提交状态追踪

#### 数据模型
```python
class Leader:
    id: int
    name: str
    department: str
    sort_order: int  # 排序顺序

class Submission:
    id: int
    leader_id: int
    week_number: str
    source: str              # 'form' | 'upload'
    content: JSON            # 表单内容或解析内容
    original_file: str       # 上传的原始文件（如有）
    status: str              # draft | submitted | checked | archived
    check_result: JSON
    created_at: datetime
    updated_at: datetime
```

#### 状态看板
```
┌────────────────────────────────────────────────────┐
│  2024年第50周 提交状态                    [导出]   │
├──────────┬──────────┬──────────┬──────────────────┤
│   姓名   │   部门   │   状态   │      操作        │
├──────────┼──────────┼──────────┼──────────────────┤
│   张三   │  办公室  │  ✅ 已交  │  [查看] [校对]   │
│   李四   │  财务部  │  ✅ 已交  │  [查看] [校对]   │
│   王五   │  技术部  │  ⏳ 未交  │  [提醒]          │
│   赵六   │  人事部  │  🔍 待审  │  [审核]          │
└──────────┴──────────┴──────────┴──────────────────┘
```

---

### 3.4 模块D：批量归档

#### 归档流程
```
选择周次 → 确认文件列表 → 设置命名规则 → 生成归档
                                    ↓
                         ┌─────────┴─────────┐
                         ▼                   ▼
                    ZIP压缩包            文件清单
                    (重命名后)          (可打印PDF)
```

#### 命名规则配置
```typescript
interface NamingConfig {
  template: string;  // "{序号}_{部门}_{姓名}_周小结"
  sortBy: 'department' | 'name' | 'custom';
  customOrder?: string[];  // 自定义排序
  startNumber: number;     // 起始序号
  numberPadding: number;   // 序号位数，如 2 → 01, 02
}
```

#### 文件清单模板
```
周小结文件清单
周次：2024年第50周
生成时间：2024-12-14 10:00

序号  文件名                          部门      姓名
────────────────────────────────────────────────────
01    01_办公室_张三_周小结.docx      办公室    张三
02    02_财务部_李四_周小结.docx      财务部    李四
03    03_技术部_王五_周小结.docx      技术部    王五
...

共计：10 份
```

---

## 四、目录结构（更新）

```
weekly-summary-platform/
├── backend/
│   ├── app/
│   │   ├── main.py
│   │   ├── config.py
│   │   ├── models/
│   │   │   ├── leader.py
│   │   │   └── submission.py
│   │   ├── routers/
│   │   │   ├── form.py          # 在线填写
│   │   │   ├── upload.py        # 文件上传
│   │   │   ├── check.py         # 校对
│   │   │   ├── status.py        # 状态查询
│   │   │   └── archive.py       # 归档
│   │   ├── services/
│   │   │   ├── checker/
│   │   │   │   ├── format_checker.py
│   │   │   │   └── deepseek_checker.py
│   │   │   ├── exporter.py      # Word导出
│   │   │   ├── archiver.py
│   │   │   └── storage.py
│   │   └── templates/
│   │       └── weekly_summary.docx  # Word模板
│   ├── requirements.txt
│   └── .env                     # DeepSeek API Key
│
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── ui/              # shadcn
│   │   │   ├── summary-form.tsx # 在线填写表单
│   │   │   ├── file-upload.tsx
│   │   │   ├── check-result.tsx
│   │   │   ├── status-board.tsx
│   │   │   └── archive-panel.tsx
│   │   ├── pages/
│   │   │   ├── submit.tsx       # 提交页（表单/上传）
│   │   │   ├── status.tsx       # 状态看板
│   │   │   ├── review.tsx       # 校对审核
│   │   │   └── archive.tsx      # 归档
│   │   ├── lib/
│   │   │   └── api.ts
│   │   └── App.tsx
│   └── package.json
│
└── README.md
```

---

## 五、技术依赖

### 后端
```txt
fastapi>=0.104.0
uvicorn>=0.24.0
python-multipart>=0.0.6
python-docx>=1.1.0
openai>=1.3.0          # DeepSeek 兼容 OpenAI SDK
sqlalchemy>=2.0.0
aiosqlite>=0.19.0
python-dotenv>=1.0.0
```

### DeepSeek 配置
```python
# .env
DEEPSEEK_API_KEY=sk-xxx
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 使用 OpenAI SDK 调用
from openai import AsyncOpenAI

client = AsyncOpenAI(
    api_key=os.getenv("DEEPSEEK_API_KEY"),
    base_url=os.getenv("DEEPSEEK_BASE_URL")
)
```

---

## 六、开发计划（更新）

### Phase 1：基础框架（2天）
- [ ] 后端 FastAPI 项目搭建
- [ ] 前端 React + shadcn 项目搭建
- [ ] 数据库模型
- [ ] 基础 API 框架

### Phase 2：在线填写模块（2天）
- [ ] 表单页面
- [ ] 表单提交接口
- [ ] Word 导出功能

### Phase 3：校对引擎（3天）
- [ ] 格式校对器
- [ ] DeepSeek 内容校对集成
- [ ] 校对结果展示页

### Phase 4：文件上传模块（1天）
- [ ] 上传接口
- [ ] Word 解析
- [ ] 与校对引擎对接

### Phase 5：状态追踪 + 归档（2天）
- [ ] 状态看板
- [ ] 批量归档
- [ ] 文件清单生成

---

## 七、待确认事项

1. **周小结模板内容**：具体有哪些填写区块？
2. **人员名单**：需要提交的领导名单和部门
3. **排序规则**：归档时按什么顺序排列？
4. **DeepSeek API**：是否已有 API Key？
